percetnageWarnings =
  'measurement_shirt_waist_belly_button': "Used for Garment</br> Waist/Chest: <span class='percent'> 0.0% </span>",
  'measurement_jacket_waist_belly_button': "Used for Garment</br> Waist/Chest: <span class='percent'> 0.0% </span>",
  'measurement_jacket_hip': "Hip/Chest: <span class='percent'> 0.0% </span>",
  'measurement_pants_thigh': "Thigh/Hip: <span class='percent'> 0.0% </span>",
  'measurement_pants_knee': "Knee/Thigh: <span class='percent'> 0.0% </span>",
  'measurement_pants_pant_cuff': "Cuff/Knee: <span class='percent'> 0.0% </span>",
  'measurement_chinos_thigh': "Thigh/Hip: <span class='percent'> 0.0% </span>",
  'measurement_chinos_knee': "Knee/Thigh: <span class='percent'> 0.0% </span>",
  'measurement_chinos_pant_cuff': "Cuff/Knee: <span class='percent'> 0.0% </span>",
  'measurement_shirt_shirt_sleeve_length': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'measurement_shirt_shirt_sleeve_length_right_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'measurement_shirt_shirt_sleeve_length_left_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'measurement_shirt_shirt_length_front_tuck_in': "Front length/Height: <span class='percent'> 0.0% </span>",
  'measurement_jacket_jacket_sleeve_length': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'measurement_jacket_jacket_sleeve_length_left_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'measurement_jacket_jacket_sleeve_length_right_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'measurement_jacket_jacket_length_front': "Length front/Height: <span class='percent'> 0.0% </span>",
  'measurement_pants_pant_length_outseam': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'measurement_pants_pant_length_outseam_left_leg': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'measurement_pants_pant_length_outseam_right_leg': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'measurement_chinos_pant_length_outseam': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'measurement_chinos_pant_length_outseam_left_leg': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'measurement_chinos_pant_length_outseam_right_leg': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'measurement_waistcoat_waistcoat_front_length_pointed': "Front length(pointed)/Height: <span class='percent'> 0.0% </span>",
  'measurement_waistcoat_waistcoat_front_length_straight': "Front length(straight)/Height: <span class='percent'> 0.0% </span>",
  'measurement_overcoat_overcoat_sleeve_length': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'measurement_overcoat_overcoat_sleeve_length_right_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'measurement_overcoat_overcoat_sleeve_length_left_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'measurement_overcoat_overcoat_front_length': "Front length/Height: <span class='percent'> 0.0% </span>"

alterPercentageWarnings =
  'garment_shirt_waist_belly_button': "Used for Garment</br> Waist/Chest: <span class='percent'> 0.0% </span>",
  'garment_jacket_waist_belly_button': "Used for Garment</br> Waist/Chest: <span class='percent'> 0.0% </span>",
  'garment_jacket_hip': "Hip/Chest: <span class='percent'> 0.0% </span>",
  'garment_pants_thigh': "Thigh/Hip: <span class='percent'> 0.0% </span>",
  'garment_pants_knee': "Knee/Thigh: <span class='percent'> 0.0% </span>",
  'garment_pants_pant_cuff': "Cuff/Knee: <span class='percent'> 0.0% </span>",
  'garment_chinos_thigh': "Thigh/Hip: <span class='percent'> 0.0% </span>",
  'garment_chinos_knee': "Knee/Thigh: <span class='percent'> 0.0% </span>",
  'garment_chinos_pant_cuff': "Cuff/Knee: <span class='percent'> 0.0% </span>",
  'garment_shirt_shirt_sleeve_length': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'garment_shirt_shirt_sleeve_length_right_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'garment_shirt_shirt_sleeve_length_left_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'garment_shirt_shirt_length_front_tuck_in': "Front length/Height: <span class='percent'> 0.0% </span>",
  'garment_jacket_jacket_sleeve_length': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'garment_jacket_jacket_sleeve_length_left_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'garment_jacket_jacket_sleeve_length_right_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'garment_jacket_jacket_length_front': "Length front/Height: <span class='percent'> 0.0% </span>",
  'garment_pants_pant_length_outseam': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'garment_pants_pant_length_outseam_left_leg': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'garment_pants_pant_length_outseam_right_leg': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'garment_chinos_pant_length_outseam': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'garment_chinos_pant_length_outseam_left_leg': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'garment_chinos_pant_length_outseam_right_leg': "Length(outseam)/Height: <span class='percent'> 0.0% </span>",
  'garment_waistcoat_waistcoat_front_length_pointed': "Front length(pointed)/Height: <span class='percent'> 0.0% </span>",
  'garment_waistcoat_waistcoat_front_length_straight': "Front length(straight)/Height: <span class='percent'> 0.0% </span>",
  'garment_overcoat_overcoat_sleeve_length': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'garment_overcoat_overcoat_sleeve_length_right_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'garment_overcoat_overcoat_sleeve_length_left_sleeve': "Sleeve/Height: <span class='percent'> 0.0% </span>",
  'garment_overcoat_overcoat_front_length': "Front length/Height: <span class='percent'> 0.0% </span>"

$.warningSiblings =
  shirt_waist_belly_button: 'shirt_chest'
  jacket_waist_belly_button: 'jacket_chest'
  jacket_hip: 'jacket_chest'
  pants_thigh: 'pants_hip_pants_no_pleats'
  pants_knee: 'pants_thigh'
  pants_pant_cuff: 'pants_knee'
  chinos_thigh: 'chinos_hip_pants_no_pleats'
  chinos_knee: 'chinos_thigh'
  chinos_pant_cuff: 'chinos_knee'
  shirt_shirt_sleeve_length: 'height_height_inches'
  shirt_shirt_sleeve_length_right_sleeve: 'height_height_inches'
  shirt_shirt_sleeve_length_left_sleeve: 'height_height_inches'
  shirt_shirt_length_front_tuck_in: 'height_height_inches'
  jacket_jacket_sleeve_length: 'height_height_inches'
  jacket_jacket_sleeve_length_left_sleeve: 'height_height_inches'
  jacket_jacket_sleeve_length_right_sleeve: 'height_height_inches'
  jacket_jacket_length_front: 'height_height_inches'
  pants_pant_length_outseam: 'height_height_inches'
  pants_pant_length_outseam_left_leg: 'height_height_inches'
  pants_pant_length_outseam_right_leg: 'height_height_inches'
  chinos_pant_length_outseam: 'height_height_inches'
  chinos_pant_length_outseam_left_leg: 'height_height_inches'
  chinos_pant_length_outseam_right_leg: 'height_height_inches'
  waistcoat_waistcoat_front_length_pointed: 'height_height_inches'
  waistcoat_waistcoat_front_length_straight: 'height_height_inches'
  overcoat_overcoat_sleeve_length: 'height_height_inches'
  overcoat_overcoat_sleeve_length_right_sleeve: 'height_height_inches'
  overcoat_overcoat_sleeve_length_left_sleeve: 'height_height_inches'
  overcoat_overcoat_front_length: 'height_height_inches'

(($) ->

  $.fn.goTo = ->
    $('html, body').animate { scrollTop: ($(this).offset().top - 250) + 'px' }, 'fast'
    this
    # for chaining

  return
) jQuery


minMaxHtml = (min, min_percent, max, max_percent) ->
  min_percent *= 100
  max_percent *= 100
  return "<span class='min-max-val'> Min: " + min + " (" + min_percent.toFixed(1) + "%)" + '<br> Max: ' + max + " (" + max_percent.toFixed(1) + "%)" + '<br/></span>'

minMaxAbsHtml = (min, max, divider) ->
  min_percent = (min / divider * 100).toFixed(1)
  max_percent = (max / divider * 100).toFixed(1)
  return "<span class='min-max-val'> Min: " + min + " (" + min_percent + "%)" + '<br> Max: ' + max + " (" + max_percent + "%)" + '<br/></span>'

$.methods =
  calculateChecks: (val, dataName) ->
    if dataName == 'garment_height_height_inches'
      $.methods.updateChecks(val, dataName)
    else
      $.methods.performCheckCalculations(val, dataName)

  updateChecks: (val, dataName) ->
    $.get('/measurement_checks', height: val)
      .done((data)->
        $.each data, (category_param_id, value_object) ->
          check = document.querySelector("[data-category-param-id='#{category_param_id}']")

          if check != null && check != undefined
            check.setAttribute('data-min', value_object.min)
            check.setAttribute('data-max', value_object.max)
      ).always(->
        $.methods.performCheckCalculations(val, dataName)
        $.methods.performValidations()
      )

  performCheckCalculations: (val, dataName) ->
    $('.checkable').each ->
      if $(this).attr('data-name') == dataName
        min = parseFloat($(this).attr('data-min'))
        max = parseFloat($(this).attr('data-max'))
        min_val = (val * min).toFixed(2)
        max_val = (val * max).toFixed(2)
        $(this).find('span.min-max-val').remove()

        html = minMaxHtml(min_val, min, max_val, max)
        $(this).prepend(html)

  calculateAbsChecks: (val, data_name) ->
    $(".checks.full_values").each ->
      if $(this).attr('data-name') == data_name
        min = parseFloat($(this).attr('data-min')).toFixed(2)
        max = parseFloat($(this).attr('data-max')).toFixed(2)

        $(this).find('span.min-max-val').remove()

        html = minMaxAbsHtml(min, max, val)
        $(this).prepend(html)

  maybeUpdateDefaultChecks: (selector = '') ->
    height = parseFloat($('#garment_height_height_inches').val())
    if height > 0
      $.get('/measurement_checks', height: height)
        .done((data)->
          $.each data, (category_param_id, value_object) ->
            check = document.querySelector("[data-category-param-id='#{category_param_id}']")

            if check != null && check != undefined
              check.setAttribute('data-min', value_object.min)
              check.setAttribute('data-max', value_object.max)
        ).always(->
          $.methods.setDefaultChecks(selector)
          $.methods.performValidations() if $('.see-submission-form').length == 0
        )

  setDefaultChecks: (selector = '') ->
    unless selector.length > 0
      selector = '.checkable'

    $(selector).each ->
      val = parseFloat($('#' + $(this).attr('data-name')).val())
      min = parseFloat($(this).attr('data-min'))
      max = parseFloat($(this).attr('data-max'))
      min_val = (val * min).toFixed(2)
      max_val = (val * max).toFixed(2)

      $(this).find('span.min-max-val').remove()

      html = minMaxHtml(min_val, min, max_val, max)
      $(this).prepend(html)

  setDefaultAbsChecks: (selector = '') ->
    unless selector.length > 0
      selector = '.checks.full_values'

    $(selector).each ->
      val = parseFloat($('#' + $(this).attr('data-name')).val()).toFixed(2)
      min = parseFloat($(this).attr('data-min')).toFixed(2)
      max = parseFloat($(this).attr('data-max')).toFixed(2)

      html = minMaxAbsHtml(min, max, val)
      $(this).html(html)

  callForItems: (element, id, review = false) ->
    url = element.data('info-url')
    review = $('.submit-form').attr('data-review')
    $.ajax
      type: 'GET'
      url: url
      dataType: 'script'
      data:
        id: id
        review: review

  callForMeasurements: () ->
    category_ids = []
    existing_ids = []
    customer_id = $('#customer_select').val()
    url = $('.items').data('url')
    review = $('.submit-form').attr('data-review')
    $('.category-checkboxes:checked').each ->
      category_ids.push $(this).val()

    $('.category-table').each ->
      existing_ids.push $(this).attr('data-id')

    if $('.category-checkboxes:checked').filter(':visible').length > 0
      $.ajax
        type: 'GET'
        url: url
        dataType: 'script'
        data:
          customer_id: customer_id
          category_ids: category_ids
          existing_ids: existing_ids
          review: review
    else
      $('.measurement-form-container').hide()
      $('#measurement-submission-form').remove()

  performCalculations: (selector = '') ->
    unless selector.length > 0
      selector = '.calculatable'

    $(selector).each ->
      $.calculations.general($(this))

  #script for disabling fields
  setDefaultReadonlies: () ->
    default_disabled = ['#measurement_shirt_shirt_length_back_tuck_in',
    '#measurement_shirt_shirt_length_front_tuck_out',
    '#measurement_shirt_shirt_length_back_tuck_out',
    '#measurement_shirt_wrist_cuff_button_cuff_with_watch',
    '#measurement_shirt_wrist_cuff_french_cuff_with_watch',
    '#measurement_shirt_wrist_cuff_french_cuff_without_watch',
    '#measurement_pants_hip_pants_with_pleats',
    '#measurement_chinos_hip_pants_with_pleats']

    $.each default_disabled, (index, name) ->
      input = $(name)

      if input.length > 0
        input.attr('readonly', true)

  setPercentageWarnings: () ->
    $.each Object.keys(percetnageWarnings), (index, name) ->
      object = $('#' + name)

      if object.length > 0
        message = percetnageWarnings[name]
        html = "<span class='percentage-warning'>" + message + ' </span>'
        target = object.closest('td').siblings('td.checks')
        unless target.find("span.percentage-warning").length
          $(html).appendTo(target)

  setAlterPercentageWarnings: () ->
    $.each Object.keys(alterPercentageWarnings), (index, name) ->
      object = $('#' + name)

      if object.length > 0
        message = alterPercentageWarnings[name]
        html = "<span class='percentage-warning'>" + message + ' </span>'
        target = object.closest('td').siblings('td.checks')
        unless target.find("span.percentage-warning").length
          $(html).appendTo(target)

  setRealPercentageWarnings: () ->
    $.each Object.keys($.warningSiblings), (index, name) ->
      object = $('#garment_' + name)

      if object.length > 0
        sibling = $.warningSiblings[name]
        percentage = (parseFloat($('#garment_' + name).val()) / parseFloat($('#garment_'+ sibling).val()) * 100).toFixed(1)
        object.closest('tr').find('.percent').html(percentage + '%')

  performValidations: () ->
    category_param_ids = []

    $('.calculatable').each ->
      category_param_ids.push($(this).closest('tr').attr('data-category-param-id'))
      name = $(this).attr('id')

      if name.indexOf("measurement_") != -1
        name = name.replace(/measurement_/, '')
      else if name.indexOf("adjustment_") != -1
        name = name.replace(/adjustment_/, '')

      if typeof $.validations[name] == 'function'
        $.validations[name]($('#garment_' + name))


    $.custom_validations.batch_validate(
      $('.measurement-form').serializeFormJSON(),
      $('#fit-form').serializeFormJSON(),
      category_param_ids
    )

  performAlterValidations: () ->
    category_param_ids = []

    $('.alteration-calculatable').each ->
      category_param_ids.push($(this).closest('tr').attr('data-category-param-id'))
      present_value = $(this).closest('td').closest('tr').find('.alteration').val()
      return if present_value == '' || present_value == undefined
      name = $(this).attr('id')
      name = name.replace(/garment_/, '')

      if typeof $.validations[name] == 'function'
        $.validations[name]($('#post_alter_garment_' + name), 'post_alter_garment_')

    $.custom_validations.batch_validate(
      $('.measurement-form').serializeFormJSON(),
      $('#fit-form').serializeFormJSON(),
      category_param_ids,
      $('#to_be_validated_summary_id').val()
    )

  addCategoryIdsToComment: () ->
    ids = []
    $('.category-checkboxes').each ->
      if $(this).is(':checked')
        ids.push $(this).val()
    setTimeout (->
      $('#active_admin_comment_category_ids').val(ids)
    ), 3000

  addChinosOutseamWarning: () ->
    chinos_outseam_left_garment = $('#garment_chinos_pant_length_outseam_left_leg')
    chinos_outseam_right_garment = $('#garment_chinos_pant_length_outseam_right_leg')

    if chinos_outseam_left_garment.length
      $.methods.appendChinoOutseamWarning(chinos_outseam_left_garment)
    if chinos_outseam_right_garment.length
      $.methods.appendChinoOutseamWarning(chinos_outseam_right_garment)

  appendChinoOutseamWarning: (garment) ->
    message = 'Please ensure that Chino outseam is 1 to 1.5" longer than trouser outseam to account for shrinkage'
    warning_html = "<span style='color: red;' class='chino-inseam-warning'>#{message}</span>"
    unless garment.closest('td').find('span.chino-inseam-warning').length
      garment.closest('td').append(warning_html)

  addProminentChestWarning: () ->
    prominent_chest =
      if $('#value_body_shape_postures_prominent_chest.adjustment-value').length
        $('#value_body_shape_postures_prominent_chest.adjustment-value')
      else
        $('#value_body_shape_postures_prominent_chest')

    jacket_neck_garment = $('#garment_jacket_neck')
    overcoat_neck_garment = $('#garment_overcoat_neck')

    if prominent_chest.find('option:selected').text() == 'Very prominent chest'
      $.methods.appendProminentChestWarning(jacket_neck_garment)
      $.methods.appendProminentChestWarning(overcoat_neck_garment)
    else
      $('span.very-prominent-chest-warning').remove()

  appendProminentChestWarning: (garment) ->
    message = 'Very prominent chest selected - please make neck smaller.'
    warning_html = "<span style='color: red;' class='very-prominent-chest-warning'>#{message}</span>"
    unless garment.closest('td').find('span.very-prominent-chest-warning').length
      garment.closest('td').append(warning_html)

  disableWaistButtonPositionField: ->
    $('#alteration_shirt_waist_button_position').attr('readonly', true)
    $('#alteration_jacket_waist_button_position').attr('readonly', true)

$(document).ready ->
  $('.custom-fancybox').fancybox
    'width': 500
    'height': 200
    'autoScale': false
    'autoSize': false
    'autoDimensions': false

  #initialize select2
  $('#customer_select').select2
    theme: 'bootstrap'
    placeholder: "Select a customer"
    minimumResultsForSearch: 1

    ajax:
      url: $('#customer_select').attr('data-load-url')
      dataType: 'json'
      delay: 250
      data: (params) ->
        q: params.term
        page: params.page

      processResults: (data, params) ->
        params.page = params.page or 1
        {
          results: data
          pagination: more: params.page * 30 < data.total_count
        }
      cache: true

  #for select
  $('#customer_select').on 'select2:select', (e) ->
    $.methods.callForItems($(this), e.params.data.id)

  #default select2 value for submit action
  id = $('#customer_select').data('customer-id')
  name = $('#customer_select').data('customer-name')
  option = $('<option selected>' + name + '</option>').val(id)
  $('#customer_select').append(option).trigger 'change'

  #default items for submit and new measurement actions for persisted customer
  if !$('.items').hasClass('hidden')
    review = $('submit-form').attr('data-review') == 'true'
    $.methods.callForItems($('#customer_select'), $('#customer_select').val(), review)

  #call for init measurement when clicking on checkboxes
  $('body').on 'change', '.category-checkboxes', (e) ->
    $.methods.addCategoryIdsToComment()
    $.methods.callForMeasurements()

  $('body').on 'click', '#hide-columns', ->
    indexes = []
    indexes.push $('#allowances').index() + 1
    indexes.push $('#final_garment').index() + 1
    action = $(this).html()

    $.each indexes, (index, value) ->
      element_td = "td:nth-child(" + value + ")"
      element_th = "th:nth-child(" + value + ")"

      if action == 'Hide columns'
        $(element_td + ',' + element_th).hide()
      else
        $(element_td + ',' + element_th).show()

    $(this).html(if action == 'Hide columns' then 'Show columns' else 'Hide columns')

  #set space between measurements and dropdown values for alterations form
  if $('.table#measurement-table').attr('data-alteration-form')
    $.methods.insertEmptyTr()

  #initialize loader
  #displaying error fields before submitting measurements form
  $('body').on 'click', '.trigger-loader', (e) ->
    submit_button = $(this)
    e.preventDefault()
    error = false
    document.getElementById('requested_state_transition').value = submit_button.val()
    fields_with_errors = []
    $('tr.error_field').each ->
      error = true
      error_field = "#{$(this).find('td:eq(0)').text().trim()} - #{$(this).find('td:eq(1)').text().trim()}"
      fields_with_errors.push(error_field)

    if error
      swal {
        html: true
        title: 'Out-of-range Measurements'
        text: "#{fields_with_errors.join('<br />')} are out of range, are you sure?"
        type: 'info'
        showCancelButton: true
        confirmButtonClass: 'btn-success'
        confirmButtonText: 'Yes'
        cancelButtonText: 'No'
        closeOnConfirm: true
        closeOnCancel: true
      }, (isConfirm) ->
        if isConfirm
          submit_button.submit()

          $('#fakeloader').fakeLoader
            spinner: 'spinner1'
            timeToHide: 65000
    else
      submit_button.submit()
      $('#fakeloader').fakeLoader
        spinner: 'spinner1'
        timeToHide: 65000

  #disabling behaviour when hitting enter submits the form
  $('body').on 'keydown keypress', '.measurement-form input, select', (e) ->
    keyCode = e.keyCode or e.which
    if keyCode == 13
      e.preventDefault()
      return false
    return

  #selecting the whole number input on click
  $('body').on 'click', 'input[type=text]', ->
    start = 0
    end = 121
    e = $(this)[0]

    if !e
      return
    else if e.setSelectionRange
      e.focus()
      e.setSelectionRange start, end
    else if e.createTextRange
      range = e.createTextRange()
      range.collapse true
      range.moveEnd 'character', end
      range.moveStart 'character', start
      range.select()
    else if e.selectionStart
      e.selectionStart = start
      e.selectionEnd = end

  #init function for adding category ids to comment(for instance on submit action)
  if !$('.items').hasClass('hidden')
    setTimeout (->
      $.methods.addCategoryIdsToComment()
    ), 3000
